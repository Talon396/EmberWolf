(include "Sources.hvos")
(externFn halt)

(fn main ()
    (TestFB)
    (SetupTrap (TrapHandler) 0)
    (FramebufferRenderBackground)
    (FramebufferDrawCenteredRect 510 382 384 512 255)
    (FramebufferDrawCenteredRect 514 386 384 512 248)
    (FramebufferDrawCenteredRect 512 384 384 512 252)

    (FramebufferDrawCenteredRect 512 384 336 464 250)
    (FramebufferDrawCenteredRect 345 384 2 464 249)
    (FramebufferDrawCenteredRect 512 152 336 2 249)
    (FramebufferDrawCenteredRect 679 383 2 464 255)
    (FramebufferDrawCenteredRect 512 615 336 2 255)
    (FramebufferRenderMonochromeBitmap 384 150 128 128 2 0 0 (OkamiLogo))
    (FramebufferRenderString 416 408 2 0 "OkamiStation")
    (UpdateSelfTestStatus "Testing RAM" (RAMIcon))
    (TestRAM)
    (UpdateSelfTestStatus "Initializing Hardware Trap Controller" 0)
    (UpdateSelfTestStatus "Diagnostics were successful!" 0)

    (BootMenuInit)

    /*(ConsoleInit)*/

    (halt)
)

(fn Exception (context cause pc vaddr)
    (int i)
    (if (u> cause 1) (do
        (ConsoleInit)
        (ConsoleWrite "EXCEPTION TRAP TRIGGERED - Cause " 33)
        (itoa cause (stringBuffer))
        (ConsoleWrite (stringBuffer) (strlen (stringBuffer)))
        (b! (stringBuffer) 10)
        (ConsoleWrite (stringBuffer) 1)
        (ConsoleWrite "===== REGISTER DUMP =====" 25)
        (ConsoleWrite (stringBuffer) 1)
        (= i 0)
        (while (u< i 19)
            (itoa (b@ (+ context (u* si 4))) (stringBuffer))
            (ConsoleWrite (stringBuffer) (strlen (stringBuffer)))
            (ConsoleWrite " " 1)
            (if (== (u% i 4) 3) (do
                (b! (stringBuffer) 10)
                (ConsoleWrite (stringBuffer) 1)
            ))
            (= i (+ i 1))
        )
        (b! (stringBuffer) 10)
        (ConsoleWrite (stringBuffer) 1)
        (ConsoleWrite "PC: " 4)
        (itoa pc (stringBuffer))
        (ConsoleWrite (stringBuffer) (strlen (stringBuffer)))
        (b! (stringBuffer) 10)
        (ConsoleWrite (stringBuffer) 1)
        (ConsoleWrite "System Halted" 13)
        (halt)
    ))
)

(var FWstack 4096)
(var FWbss_end 0)